<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ePlus Smart Sale Synchronizer</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:400,500,700" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/mainWindow.css">
    <script>
        const { ipcRenderer,remote } = require('electron'), { dialog,BrowserWindow } = remote, currentWindow = remote.getCurrentWindow(),
            $ = require('jquery'), _ = require('lodash'), fs = require('fs'), db = require('mysql'), path = require('path'), url = require('url'),
            maxLog = 15, continueInterval = 1500, processTableWindowConfig = { width:300, height:300, show:false },
            quitConfirmOptions = { type: 'info', title: 'Confirm Quit', message: 'Are you sure, you want to quit ?', buttons: ['No, go Back','Yes, Quit'] };

        let syncInfo,syncFile,userPath,uuidFilePath,client,mysqlParams,mysql,tblData = {},processQueue = {}, doContinue = true,
            inWork = false, processTableWindow = null,workTimeOut = 0;

        const customImports = ['importreceipts','idata'];

        ipcRenderer.on('log',function(event,text){ log(text); });
        ipcRenderer.on('complete-process-table',function(event,tblDetails){
            if(processTableWindow && !processTableWindow.isDestroyed()) processTableWindow.destroy();
            processTableWindow = null;
            if(tblDetails && !_.isEmpty(tblDetails)) reQueueSyncForTable.apply(this,tblDetails);
        });

        $(function(){
            initApp(ipcRenderer.sendSync('get-all-config'));
            setInterval(doProcessQueue,continueInterval);
        });
        function initApp(configs){
            log('Initializing sync..');
            syncInfo = configs.syncInfo; syncFile = configs.syncFilePath; userPath = configs.userPath; uuidFilePath = configs.uuidFilePath;
            mysqlParams = _.assign({ dateStrings:true },configs.mysqlParams);
            setupApp(configs.ssConfig); setupMysqlConnection();
            loadTblData(function(){ _.forEach(syncInfo,initTable); });// addToProcessQueue(getTimeNow(),['setup','up']);
        }
        function setupApp(config){
            ssConfig = config;
            $('#company_name').text(ssConfig.name); $('#application').text(ssConfig.application);
            fs.readFile(uuidFilePath,function(error,uuid){
                if(error) log('Error in reading uuid file!!');
                client = uuid.toString();
            })
        }
        function loadTblData(callback){
            fs.access(syncFile,function(error){
                if(error) return callback.call(callback);
                fs.readFile(syncFile,function(error,data){
                    if(!error) tblData = JSON.parse(data.toString());
                    callback.call(callback);
                })
            });
        }
    </script>
    <script>
        function log(text) { $('<pre>').text(`${(new Date().getTime()).toString().substr(7)} :: ${text}`).slideUp().prependTo('#log').slideDown(200).parent('#log').children(`:gt(${maxLog})`).remove(); }
        function workDependentChanges(){
            $('#minimize_tray')[doContinue?'removeClass':'addClass']('d-none');
            if(!inWork) {
                $('#alter_continue').prop('disabled',false);
                $('#quit_app')[doContinue?'addClass':'removeClass']('d-none');
                setWorkingDisplay('','');
            }
        }
        function quitApp(){ dialog.showMessageBox(quitConfirmOptions,(index) => { if(index) send('quit-app'); }) }
        function alterContinue(){ doContinue = !doContinue; $('#alter_continue').text((doContinue?'Pause':'Continue') + ' Sync') }
        function minimizeToTray(){ send('minimize-to-tray'); }
        function updateWorking(){ clearTimeout(workTimeOut); $('.app-title').addClass('working'); workTimeOut = setTimeout(function(){ $('.app-title').removeClass('working'); },continueInterval*3); }
        function setWorkingDisplay(text,type){ let types = ['up','down','both']; $('.queue-working').text(text).addClass(type).removeClass(_.without(types,type)); }
        function initTable(data){
            const { id,table,type,delay,sync,record } = data, timeNow = getTimeNow();
            let source = { id, sync, record, type, delay:parseInt(delay) };
            if(!_.has(tblData,table)) tblData[table] = source; else _.assign(tblData[table],source);
            if(!_.has(tblData[table],'primary_key') || _.isEmpty(tblData[table].primary_key))
                getTablePrimaryFields(table).then(function(Obj){ _.forEach(Obj,(primary_key,table) => updateTblData(table,'primary_key',primary_key)) });
            if(!_.has(tblData[table],'fields') || _.isEmpty(tblData[table].fields))
                getTableFields(table).then(function(Obj){ _.forEach(Obj,(fields,table) => updateTblData(table,'fields',fields)) });
            addToProcessQueue(timeNow,[table,type,delay]);// addToProcessQueue(timeNow,[table,'down']);
        }
        function send(channel,args){ ipcRenderer.send.apply(null,[channel,args]) }
        function getInteractUrl(tbl){
            let { protocol,host,pathname } = url.parse(ssConfig.url_interact);
            pathname = path.join(pathname.substr(1),'sync',client,tbl);
            return url.format({ protocol,host,pathname }).toString();
        }
    </script>
    <script>
        function setupMysqlConnection(){
            mysql = db.createConnection(mysqlParams);
            mysql.connect(function(error){ if(!error) return log('Database connection established..'); mysql = null; log('Could not establish database connection.'); });
        }
        function getTablePrimaryFields(table){
            return new Promise(function(resolve,reject){
                mysql.query('SHOW CREATE TABLE ??',table,function(error,result){
                    let CreateTable = _.get(_.head(result),'Create Table'), pattern = new RegExp(/PRIMARY KEY \(`(.*)`\)/), split = '`,`';
                    if(error) return reject(`Error while trying to get primary fields from table: ${table}`);
                    return resolve(_.zipObject([table],[pattern.exec(CreateTable)[1].split(split)]));
                });
            })
        }
        function getTableFields(table){
            return new Promise(function(resolve,reject){
                mysql.query('SELECT * FROM ?? LIMIT 1',table,function(error, result, fieldPackets){
                    if(error) return reject(`Error while trying to get field from table: ${table}`);
                    return resolve(_.zipObject([table],[getFieldArrayFromFieldPackets(fieldPackets)]))
                })
            })
        }
        function getFieldArrayFromFieldPackets(fieldPackets){ return _.map(fieldPackets,'name'); }
    </script>
    <script>
        function getTimeNow(){ return parseInt((new Date().getTime()/1000).toString().substr(4)); }
        function updateTblData(table,property,value){
            if(!_.has(tblData,table)) tblData[table] = new Object({});
            if(!_.has(tblData[table],property)) tblData[table][property] = null;
            tblData[table][property] = value; saveTblData();
        }
        function saveTblData(){
            fs.writeFile(syncFile,JSON.stringify(tblData),function(error){
                if(!error) return; doContinue = false;
                log('Error in saving sync info file!!');
            });
        }
        function isOneTimeTable( { fields } ){ return (!_.includes(fields,'CREATED_DATE') && !_.includes(fields,'MODIFIED_DATE')) }
        function reQueueSyncForTable(table,type){
            let delay = parseInt(tblData[table].delay); if(!delay) return inWork = false;
            if(!inQueue(table,type)) addToProcessQueue(delay + getTimeNow(),[table,type]);
            log('Table: ' + table + ', added to Queue'); return inWork = false;
        }
        function inQueue(table,type){ return _.some(processQueue,(arr)=>(arr[0] === table && arr[1] === type)); }
        function addToProcessQueue(no,data){ return processQueue.hasOwnProperty(no) ? addToProcessQueue(++no,data) : putProcessQueue(no,data); }
        function putProcessQueue(no,data){ processQueue[no] = data; displayProcessQueue(); }
        function getQueueItem(text,type,id){ return $('<a>').addClass(['queue-item',type,id]).text(text); }
        function displayProcessQueue(){ let queueDiv = $('#queue'); $('.queue-item',queueDiv).remove(); _.forEach(processQueue,(data,id) => { queueDiv.append(getQueueItem(data[0],data[1],id)); }); }
        function haveQueueEarlierThan(num){ let first = _.head(_.keys(processQueue)); return !!(first && parseInt(first) <= parseInt(num)); }
        function pullFirstFromQueue(){ let first = _.head(_.keys(processQueue)), data = null; if(first) data = processQueue[first]; delete processQueue[first]; removeQueueDisplay(first); return data; }
        function removeQueueDisplay(no){ $('.queue-item.'+no).slideUp(function(){ this.remove() }); }
    </script>
    <script>
        function doProcessQueue(){
            let timeNow = getTimeNow(); workDependentChanges();
            if(!doContinue || inWork || !haveQueueEarlierThan(timeNow) || processTableWindow !== null) return;
            let data = pullFirstFromQueue(); if(!data) return;
            inWork = true; updateWorking(); setWorkingDisplay(data[0],data[1]);
            let iUrl = getInteractUrl(data[0]);
            processTableWindow = new BrowserWindow(processTableWindowConfig).on('closed', function(){ processTableWindow = null; inWork = false; });
            processTableWindow.loadURL(path.join(__dirname,'sessions','processTable.html'));
            processTableWindow.webContents.on('did-finish-load',function(){
                loadTblData(function(){
                    processTableWindow.webContents.send('config',{
                        table:data[0],type:data[1],tblData,parentWindowId:currentWindow.id,syncFile,
                        mysqlParams,url:iUrl,custom:(customImports.indexOf(data[0]) > -1)
                    });
                })
            });
        }

    </script>
</head>
<body class="bg-light mt-2">
<div class="container-fluid">
    <div class="row">
        <div class="col col-8"><h5 class="text-primary text-left mt-0 mb-0" id="company_name"></h5><span class="small" id="application"></span></div>
        <div class="col-4 text-right app-title"><p class="text-primary font-weight-light">ePlus Smart Sale<br>Synchronizer <script>document.write(require('./package').version)</script></p></div>
    </div>
    <hr class="m-0 mb-3">
    <div class="row" id="main">
        <div class="col-9 font-italic pr-0 border-right" id="log"></div>
        <div class="col-3 font-italic" id="queue">
            <a class="queue-working"></a>
        </div>
    </div>
</div>
<footer class="fixed-bottom clearfix">
    <div class="text-center container-fluid" style="height: 40px;">
        <button id="quit_app" class="btn btn-danger btn-sm d-none" onclick="quitApp()">QUIT</button>
        <button id="alter_continue" class="btn btn-warning btn-sm" onclick="this.setAttribute('disabled',true);alterContinue();">Pause Sync</button>
        <button id="minimize_tray" class="btn btn-warning btn-sm" onclick="minimizeToTray()">Minimize to Tray</button>
    </div>
    <hr class="m-0 mt-2">
    <div class="row p-2" style="color: #C8C8C8">
        <div class="col col-6"><p class="small pl-3 m-0 font-weight-light">Powered by<br>ePlus</p></div>
        <div class="col col-6"><p class="small pr-3 m-0 text-right font-weight-light">Copyright Protected by<br>Milestone Innovative Technologies</p></div>
    </div>
</footer>
</body></html>